<link href="../../../polymer/polymer-element.html" rel="import">
<link href="../../../vaadin-themable-mixin/vaadin-themable-mixin.html" rel="import">
<link href="../../../vaadin-element-mixin/vaadin-element-mixin.html" rel="import">
<link href="color-picker-sl-slider.html" rel="import">
<link href="color-picker-hue-slider.html" rel="import">
<link href="color-picker-alpha-slider.html" rel="import">
<link href="color-picker-selected-color.html" rel="import">
<link href="../utils/vaadin-disabled-property-mixin.html" rel="import"/>
<link href="../utils/color-picker-has-color-value-mixin.html" rel="import"/>
<link href="../libraries/chroma-js-import.html" rel="import"/>

<dom-module id="color-picker-slider">
  <template>
    <style include="color-picker-shared-styles">
      :host {
        display: flex;
      }

      :host > *, sl-slider {
        flex-grow: 1;
      }

      selected-color {
        flex-grow: 0 !important;
      }
    </style>

    <div class="vertical-spacing">
      <sl-slider disabled$="[[disabled]]"
                 hue="[[_hue]]"
                 step-x="[[_stepSl(stepHsl)]]"
                 step-y="[[_stepSl(stepHsl)]]"
                 theme$="[[theme]]"
                 value-x="{{_saturation}}"
                 value-y="{{_value}}"></sl-slider>
      <div class="horizontal-spacing" style="align-self: stretch;align-items: center;">
        <selected-color disabled$="[[disabled]]"
                        previous-value="[[previousValue]]"
                        value="{{value}}"></selected-color>
        <div class="vertical-spacing">
          <hue-slider disabled$="[[disabled]]"
                      id="hueSlider"
                      step-x="[[stepHsl]]"
                      theme$="[[theme]]"
                      value-x="{{_hue}}"></hue-slider>
          <alpha-slider disabled$="[[disabled]]"
                        hidden$="[[disableAlpha]]"
                        hue="[[_hue]]"
                        id="alphaSlider"
                        step-x="[[stepAlpha]]"
                        theme$="[[theme]]"
                        value="[[_value]]"
                        value-x="{{_alpha}}"></alpha-slider>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function() {

      /**
       * `<color-picker-slider>` allows to select a color from sliders.
       *
       * @memberof Vaadin.ColorPicker
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @mixes Vaadin.DisabledPropertyMixin
       * @mixes Vaadin.ColorPicker.HasColorValueMixin
       */
      class ColorPickerSliderElement extends Vaadin.ElementMixin(Vaadin.ThemableMixin(
        Vaadin.DisabledPropertyMixin(Vaadin.ColorPicker.HasColorValueMixin(Polymer.Element)))) {

        static get is() {
          return 'color-picker-slider';
        }

        static get version() {
          return '0.7.8';
        }

        static get properties() {
          return {
            /**
             * The previous value.
             */
            previousValue: Object,
            /**
             * Disable the input of **alpha** values.
             */
            disableAlpha: {
              type: Boolean,
              value: false
            },
            /**
             * Allowed number o intervals on the **alpha** value
             */
            stepAlpha: {
              type: Number,
              value: 0.01
            },
            /**
             * Allowed number o intervals on the **hsl** value
             */
            stepHsl: {
              type: Number,
              value: 1
            },
            /**
             * The current hue in the range `[0 - 360]`.
             */
            _hue: {
              type: Number,
              value: 0,
              observer: '_sliderColorChanged'
            },
            /**
             * The current saturation in the range `[0 - 1]`.
             */
            _saturation: {
              type: Number,
              value: 1,
              observer: '_sliderColorChanged'
            },
            /**
             * The current value in the range `[0 - 1]`.
             */
            _value: {
              type: Number,
              value: 1,
              observer: '_sliderColorChanged'
            },
            /**
             * The current alpha in the range `[0 - 1]`.
             */
            _alpha: {
              type: Number,
              value: 1,
              observer: '_sliderColorChanged'
            }
          };
        }

        /**
         * @protected
         */
        ready() {
          super.ready();
          this._createPropertyObserver('value', '_valueChanged', true);
        }

        /**
         * Update the color value if the slider values changed.
         * @private
         */
        _sliderColorChanged() {
          this._colorChanged(() => {
            this.value = chroma.hsv(this._hue, this._saturation, this._value).alpha(this._alpha);
          });
        }

        /**
         * Update the slider values if the color value changed.
         * @private
         */
        _valueChanged() {
          this._colorChanged(() => {
            if (this.value) {
              this._hue = this.value.get('hsv.h');
              this._saturation = this.value.get('hsv.s');
              this._value = this.value.get('hsv.v');
              this._alpha = this.value.alpha();
            } else {
              this._hue = 0;
              this._saturation = 1;
              this._value = 1;
              this._alpha = 0;
            }
          });
        }

        /**
         * Prevent endless recursion.
         * @param updateAction
         * @private
         */
        _colorChanged(updateAction) {
          if (!this._updatingColor) {
            this._updatingColor = true;
            updateAction();
            this._updatingColor = false;
          }
        }

        _stepSl() {
          return this.stepHsl > 0.01 ? 0.01 : this.stepHsl;
        }
      }

      customElements.define(ColorPickerSliderElement.is, ColorPickerSliderElement);

      /**
       * @namespace Vaadin.ColorPicker
       */
      window.Vaadin = window.Vaadin || {};
      window.Vaadin.ColorPicker = window.Vaadin.ColorPicker || {};
      window.Vaadin.ColorPicker.ColorPickerSliderElement = ColorPickerSliderElement;
    })();
  </script>
</dom-module>
