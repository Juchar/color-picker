<link href="../../bower_components/vaadin-checkbox/src/vaadin-checkbox.html" rel="import">
<link href="../libraries/chroma-js-import.html" rel="import"/>

<dom-module id="color-checkbox">
  <script>
    (function() {

      let memoizedTemplate;

      /**
       * `<color-checkbox>` extends the `<vaadin-checkbox>` to be suitable for selecting colors.
       * The color of the checkmark itself will be adjusted automatically to be readable on the
       * background color of the checkbox.
       *
       * @memberof Vaadin.ColorPicker
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @mixes Vaadin.DisabledPropertyMixin
       */
      class ColorCheckboxElement extends Vaadin.CheckboxElement {

        static get is() {
          return 'color-checkbox';
        }

        static get version() {
          return '0.1.0';
        }

        static get properties() {
          return {
            /**
             * The color for the checkbox in the form of a
             * [chroma.js](https://github.com/gka/chroma.js/|chroma.js) chroma object.
             */
            color: {
              type: Object,
              notify: true
            }
          };
        }

        static get template() {
          if (!memoizedTemplate) {
            memoizedTemplate = Vaadin.CheckboxElement.template.cloneNode(true);

            const div = document.createElement('div');
            div.setAttribute('part', 'color-backdrop');

            memoizedTemplate.content.querySelector('label').prepend(div);
          }
          return memoizedTemplate;
        }

        /**
         * @protected
         */
        ready() {
          super.ready();
          this._createPropertyObserver('color', '_onColorChanged', true);
        }

        /**
         * Disable un-checking the checkbox once it has been checked.
         * @private
         */
        _toggleChecked() {
          if (!this.checked) {
            super._toggleChecked();
          }
        }

        /**
         * Update the checkbox styles.
         * @private
         */
        _onColorChanged() {
          const element = this.shadowRoot.querySelector('[part="checkbox"]');
          element.classList.remove('light-color', 'dark-color', 'show-border');

          if (this.color) {
            element.style.background = this.color.css();
            element.classList.add(this.color.luminance() > 0.5 ? 'light-color' : 'dark-color');
            element.style.color =
              this.color.luminance() > 0.5
              ? this.color.alpha(1).set('hsl.s', 1).set('hsl.l', .5).darken(2.5).css()
              : this.color.alpha(1).set('hsl.s', 1).set('hsl.l', .5).brighten(2.5).css();

            if (this.color.luminance() > 0.96) {
              element.classList.add('show-border');
            }
          } else {
            element.style.background = null;
          }
        }
      }

      customElements.define(ColorCheckboxElement.is, ColorCheckboxElement);

      /**
       * @namespace Vaadin.ColorPicker
       */
      window.Vaadin = window.Vaadin || {};
      window.Vaadin.ColorPicker = window.Vaadin.ColorPicker || {};
      window.Vaadin.ColorPicker.ColorCheckboxElement = ColorCheckboxElement;
    })();
  </script>
</dom-module>
