<link href="../../polymer/polymer-element.html" rel="import">
<link href="../../vaadin-themable-mixin/vaadin-themable-mixin.html" rel="import">
<link href="../../vaadin-element-mixin/vaadin-element-mixin.html" rel="import">
<link href="slider/color-picker-color-picker-slider.html" rel="import">
<link href="input/color-picker-color-picker-input.html" rel="import">
<link href="palette/color-picker-color-picker-palette.html" rel="import">
<link href="utils/vaadin-disabled-property-mixin.html" rel="import">
<link href="utils/color-picker-utils.html" rel="import">
<link href="libraries/chroma-js-import.html" rel="import"/>

<dom-module id="color-picker">
  <template>
    <style include="color-picker-shared-styles">
      :host {
        display: block;
        max-width: 100%;
      }

      color-picker-input,
      color-picker-palette {
        flex-grow: 0 !important;
      }

      color-picker-input {
        margin-top: 0 !important;
      }
    </style>

    <div class="vertical-spacing" style="align-items: stretch; min-height: 100%;">
      <color-picker-slider disable-alpha="[[disableAlpha]]"
                           disabled$="[[disabled]]"
                           previous-value="[[_previousValueInternal]]"
                           step-alpha="[[stepAlpha]]"
                           step-hsl="[[stepHsl]]"
                           theme$="[[theme]]"
                           value="{{_valueInternal}}"></color-picker-slider>
      <color-picker-input disable-alpha="[[disableAlpha]]"
                          disable-hex="[[disableHex]]"
                          disable-hsl="[[disableHsl]]"
                          disable-rgb="[[disableRgb]]"
                          disabled$="[[disabled]]"
                          hidden$="[[!_showInputs(disableHex,disableRgb,disableHsl)]]"
                          last-used-format="{{lastUsedFormat}}"
                          pinned="[[pinnedInputs]]"
                          step-alpha="[[stepAlpha]]"
                          step-hsl="[[stepHsl]]"
                          theme$="[[theme]]"
                          value="{{_valueInternal}}"></color-picker-input>
      <color-picker-palette disabled$="[[disabled]]"
                            hidden$="[[!_showPalettes(_palettesInternal)]]"
                            palettes="[[_palettesInternal]]"
                            pinned="[[pinnedPalettes]]"
                            theme$="[[theme]]"
                            value="{{_valueInternal}}"></color-picker-palette>
    </div>
  </template>

  <script>
    (function() {

      /**
       * `<color-picker>` allows to select a color using sliders, inputs or palettes.
       *
       * ```
       * <color-picker></color-picker>
       * ```
       *
       * @memberof Vaadin.ColorPicker
       * @mixes Vaadin.ElementMixin
       * @mixes Vaadin.ThemableMixin
       * @mixes Vaadin.DisabledPropertyMixin
       * @demo demo/index.html
       */
      class ColorPicker extends Vaadin.ElementMixin(
        Vaadin.ThemableMixin(Vaadin.DisabledPropertyMixin(Polymer.Element))) {

        static get is() {
          return 'color-picker';
        }

        static get version() {
          return '0.7.7';
        }

        static get properties() {
          return {
            disableHex: {
              type: Boolean,
              value: false
            },
            disableRgb: {
              type: Boolean,
              value: false
            },
            disableHsl: {
              type: Boolean,
              value: false
            },
            disableAlpha: {
              type: Boolean,
              value: false
            },
            pinnedInputs: {
              type: Boolean,
              value: false
            },
            pinnedPalettes: {
              type: Boolean,
              value: false
            },
            value: {
              type: String,
              notify: true,
              observer: '_onValueChanged'
            },
            previousValue: {
              type: String,
              observer: '_onPreviousValueChanged'
            },
            lastUsedFormat: {
              type: String,
              notify: true,
              observer: '_onValueInternalChanged'
            },
            palettes: {
              type: Array,
              observer: '_onPalettesChanged'
            },
            stepAlpha: {
              type: Number,
              value: 0.01
            },
            stepHsl: {
              type: Number,
              value: 1
            },
            _valueInternal: {
              type: Object,
              observer: '_onValueInternalChanged'
            },
            _previousValueInternal: Object,
            _palettesInternal: {
              type: Array,
              value: []
            },
          };
        }

        ready() {
          const initialColor = this.value ? this.value : this.previousValue;
          super.ready();

          if (initialColor) {
            this.value = chroma(this._getResolvedValue(initialColor));
          }
        }

        _showPalettes() {
          return this._palettesInternal ? this._palettesInternal.length > 0 : false;
        }

        _showInputs() {
          return !(this.disableHex && this.disableRgb && this.disableHsl);
        }

        _onValueChanged() {
          if (!this.valueInternalChanged) {
            this.valueChanged = true;
            this._valueInternal = this.value ? chroma(this._getResolvedValue(this.value)) : undefined;
            this.valueChanged = false;
          }
        }

        _onValueInternalChanged() {
          if (!this.valueChanged) {
            this.valueInternalChanged = true;
            this.value = this._valueInternal
              ? ColorPickerUtils.getFormattedColor(this._valueInternal, this.lastUsedFormat, this.stepAlpha,
                this['step' + this.lastUsedFormat.charAt(0).toUpperCase() + this.lastUsedFormat.slice(1)] || 1)
              : undefined;
            this.valueInternalChanged = false;
          }
        }

        _onPreviousValueChanged() {
          this._previousValueInternal = this.previousValue ? chroma(this._getResolvedValue(this.previousValue)) : undefined;
        }

        _onPalettesChanged() {
          this._palettesInternal =
            this.palettes ? this.palettes.map(palette => palette.map(color => chroma(this._getResolvedValue(color))))
              : undefined;
        }

        _getResolvedValue(value) {
          return /--[a-zA-Z0-9]+[a-zA-Z0-9-]*/gm.test(value)
            ? window.getComputedStyle(this).getPropertyValue(value).trim()
            : value;
        }
      }

      customElements.define(ColorPicker.is, ColorPicker);

      window.Vaadin = window.Vaadin || {};
      window.Vaadin.ColorPicker = window.Vaadin.ColorPicker || {};
      window.Vaadin.ColorPicker.ColorPicker = ColorPicker;
    })();
  </script>
</dom-module>
